import requests
import replicate  # <-- ДОБАВЬТЕ ЭТОТ ИМПОРТ!

SYSTEM_PROMPT = """
Ты — опытный менеджер по продажам компании Фортис металл и дизайн, специализирующейся на оптовых и розничных поставках металлопроката. Ты вежливый, компетентный, ориентированный на клиента и умеешь вести деловой диалог. Твоя задача — помочь посетителю сайта подобрать нужный вид металлопроката, ответить на вопросы, предложить выгодные решения и, при наличии интересной заявки (от 50 000 рублей), корректно собрать контактные данные и отправить заявку на почту отдела продаж.

Твоя роль:
Выдавай себя за живого менеджера по имени Аркадий. Отвечай с задержкой, как если бы ты печатал текст вживую.
Представляйся кратко: «Здравствуйте, менеджер Аркадий. Готов помочь с подбором металлопроката и оформлением заказа.»

Веди себя профессионально, но дружелюбно. Не используй сленг, но и не будь слишком формальным.

Говори кратко, по делу, избегай длинных абзацев. Отвечай понятно, особенно если клиент может не разбираться в терминах.

Что ты должен уметь:

Задавать уточняющие вопросы, если запрос клиента неполный:

Какой вид металлопроката вас интересует? (листовой прокат, арматура, трубы, профиль, уголок, швеллер, балка и т.д.)

Какие параметры? (марка стали, толщина, длина, диаметр, вес, тип покрытия — оцинковка, окраска и пр.)

На какую сферу применения? (строительство, производство, ремонт, монтаж и т.п.)

Нужна доставка? (уточни регион или город)

Предпочтительный объём заказа?

Подсказывать и предлагать альтернативы, если нужно:

Например: «У нас в наличии есть аналог по ГОСТ 535-2005, он на 15% дешевле и подходит для ваших задач.»

Предлагай популярные позиции или акции, если они есть (можно оставить место для динамического обновления: «Сейчас действует специальное предложение на стальной лист Ст3сп»).

Работать с заявками от 50 000 руб.:

Если клиент указал объём заказа или сумма по расчёту превышает 50 000 руб., мягко переходи к сбору данных:
«Это уже серьёзный заказ — давайте я передам его секретарю, чтобы она назначила ответственного менеджеа, чтобы вам перезвонили и предложили лучшие условия. Назовите, пожалуйста, ваше имя, телефон и email?»

Подтверди: «Спасибо Ваши данные отправлены. С вами свяжутся в течение 30 минут.»

Отправляй заявку на почту:

Все заявки (с указанием: ФИО, телефон, email, описание запроса, сумма, дата и время) автоматически отправляются на 229@fortis-steel.ru (или другую указанную почту).

Отвечай на частые вопросы:

«Работаете ли вы с НДС?» — Да, все цены указаны с НДС.

«Есть ли самовывоз?» — Да, все данные и контакты вам даст назначенный ответственный.

«Минимальный заказ?» — От 50 000 руб.

Завершай диалог вежливо:

Если клиент уходит: «Буду рад помочь в следующий раз. Удачи вам»

Важно:

Не выдумывай информацию, которой нет. Если не знаешь — скажи: «Уточню у коллег и вернусь с ответом» 
Не предлагай скидки без подтверждения. Лучше: «По таким объёмам менеджер может предложить индивидуальные условия.»
"""

# Переменную REPLICATE_MODEL можно оставить для справки, но в новой функции она не используется напрямую
REPLICATE_MODEL = "openai/gpt-5"  # пример модели

def generate_bot_reply(api_key: str, message: str) -> str:
    """Генерация ответа бота через Replicate API."""
    try:
        print(f"\n=== ДЕБАГ: Начинаем генерацию ===")
        print(f"Сообщение: '{message}'")
        
        client = replicate.Client(api_token=api_key)
        
        # 1. Создаем ПРАВИЛЬНЫЙ промпт для GPT-5
        full_prompt = f"""{SYSTEM_PROMPT}

Теперь отвечай как менеджер Аркадий.

Вопрос клиента: {message}

Ответ Аркадия:"""
        
        print(f"Длина полного промпта: {len(full_prompt)} символов")
        print(f"Первые 500 символов: {full_prompt[:500]}...")
        
        # 2. Отправляем запрос как в документации Replicate
        # Важно: возможно нужен streaming как в примере
        output = replicate.run(
            "meta/meta-llama-3-70b-instruct",
            input={
                "prompt": full_prompt,
                "max_tokens": 1000,
                "temperature": 0.8,
                "top_p": 0.9
            }
        )
        
        print(f"Тип ответа: {type(output)}")
        print(f"Ответ сырой: {output}")
        
        # 3. Обрабатываем ответ (GPT-5 может вернуть генератор)
        result = ""
        if hasattr(output, '__iter__') and not isinstance(output, str):
            # Если это генератор/stream (как в документации)
            for chunk in output:
                if isinstance(chunk, str):
                    result += chunk
                else:
                    result += str(chunk)
        elif isinstance(output, str):
            result = output
        else:
            result = str(output)
        
        print(f"Итоговый ответ: {result[:200]}...")
        print(f"=== ДЕБАГ: Конец генерации ===\n")
        
        return result.strip() if result.strip() else "Извините, не получилось сгенерировать ответ."
            
    except Exception as e:
        print(f"ДЕБАГ: Ошибка: {str(e)}")
        return f"Ошибка: {str(e)}"

# --- ЛОГИКА ОПРЕДЕЛЕНИЯ "ИНТЕРЕСНОЙ ЗАЯВКИ" (оставляем без изменений) ---

KEYWORDS = [
    "купить", "заказать", "арматура", "труба", "лист", "швеллер", "профнастил", "оцинкованный", "оцинковка", "профлист", "перфорированный",
    "балка", "уголок", "металл", "металлопрокат", "стоимость", "цена", "штрипс", "рулон",
    "опт", "оптовый", "крупный", "партия", "поставк",  # контекстные слова
    "заявк", "оформ", "договор",  # признаки серьезности
]

def check_interesting_application(text: str):
    t = text.lower()
    
    # Существующая проверка ключевых слов
    if not any(k in t for k in KEYWORDS):
        return False, 0
    
    # Улучшенный поиск сумм
    import re
    
    # Шаблон 1: Явные суммы ("50000 руб", "100 тыс", "1.5 млн")
    money_patterns = [
        r'(\d+)\s*(?:тыс|т\.?р|тр|руб|р\.?)',  # 50 тыс руб
        r'(\d+)\s*(?:млн|миллион)',            # 1 млн
        r'(?:заказ|заявк[ау]|сумм[аой]|на\s+сумму)\s*[вна]?\s*(\d+)',  # заказ на 50000
        r'(\d+)\s*(?:тонн|тн?)[^.]*руб',       # 3 тонны по 20000
    ]
    
    for pattern in money_patterns:
        matches = re.findall(pattern, t)
        for match in matches:
            num = int(match)
            # Конвертируем тыс/млн
            if 'тыс' in pattern or any(word in pattern for word in ['т.р', 'тр', 'труб']):
                num *= 1000
            elif 'млн' in pattern:
                num *= 1000000
            if num >= 50000:
                return True, num
    
    # Шаблон 2: Количества и цены ("5 тонн по 15000")
    quantity_price = re.search(r'(\d+)\s*(?:тонн|тн?|шт)[^.]*по\s*(\d+)', t)
    if quantity_price:
        quantity = int(quantity_price.group(1))
        price = int(quantity_price.group(2))
        total = quantity * price
        if total >= 50000:
            return True, total
    
    # Шаблон 3: Просто большие числа (резервный вариант)
    numbers = [int(n) for n in re.findall(r'\b\d{5,}\b', t)]  # только 5+ знаков
    amounts = [n for n in numbers if n >= 50000]
    
    return (True, max(amounts)) if amounts else (False, 0)

